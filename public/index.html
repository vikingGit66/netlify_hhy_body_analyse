<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>数据提交系统</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>数据提交系统</h1>
            <nav>
                <a href="/">首页</a>
                <a href="logs.html">查看日志</a>
            </nav>
        </header>
        
        <main>
            <section class="form-section">
                <h2>提交数据</h2>
                <div class="form-group">
                    <label for="name">姓名</label>
                    <input type="text" id="name" placeholder="请输入姓名">
                </div>
                
                <div class="form-group">
                    <label for="email">邮箱</label>
                    <input type="email" id="email" placeholder="请输入邮箱">
                </div>
                
                <div class="form-group">
                    <label for="message">留言</label>
                    <textarea id="message" rows="4" placeholder="请输入留言内容"></textarea>
                </div>
                
                <button onclick="submitData()">提交数据</button>
                
                <div id="result" class="result-panel">
                    <div class="loading">等待操作...</div>
                </div>
            </section>
            
            <section class="recent-logs">
                <h2>最近日志 <button class="refresh-btn" onclick="loadRecentLogs()">刷新</button></h2>
                <div id="recentLogs" class="logs-container"></div>
            </section>
        </main>
        
        <footer>
            <p>© 2023 数据提交系统 | 日志版本: <span id="logVersion">1.0.0</span></p>
        </footer>
    </div>
    
    <script src="scripts.js"></script>
    <script>
        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', () => {
            loadRecentLogs();
            document.getElementById('logVersion').textContent = 
                new Date().toISOString().split('T')[0].replace(/-/g, '.');
        });
        
        // 加载最近日志
        async function loadRecentLogs() {
            const logsContainer = document.getElementById('recentLogs');
            logsContainer.innerHTML = '<div class="loading">加载日志中...</div>';
            
            try {
                const response = await fetch('/api/logs?limit=5');
                const data = await response.json();
                
                if (!data.success || !data.logs || data.logs.length === 0) {
                    logsContainer.innerHTML = '<div class="empty">没有找到日志记录</div>';
                    return;
                }
                
                logsContainer.innerHTML = '';
                
                data.logs.forEach(log => {
                    const logElement = createLogElement(log);
                    logsContainer.appendChild(logElement);
                });
                
            } catch (error) {
                logsContainer.innerHTML = `<div class="error">加载日志失败: ${error.message}</div>`;
            }
        }
        
        // 提交数据
        async function submitData() {
            const name = document.getElementById('name').value;
            const email = document.getElementById('email').value;
            const message = document.getElementById('message').value;
            
            const resultPanel = document.getElementById('result');
            resultPanel.innerHTML = '<div class="loading">提交中，请稍候...</div>';
            
            try {
                const response = await fetch('/api/submit', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({ name, email, message })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    resultPanel.innerHTML = `
                        <div class="success">
                            <h3>提交成功！</h3>
                            <p>ID: ${data.data.id}</p>
                            <p>姓名: ${data.data.name}</p>
                            <p>邮箱: ${data.data.email}</p>
                            <p>消息: ${data.data.message}</p>
                        </div>
                    `;
                    
                    // 清空表单
                    document.getElementById('name').value = '';
                    document.getElementById('email').value = '';
                    document.getElementById('message').value = '';
                } else {
                    resultPanel.innerHTML = `
                        <div class="error">
                            <h3>提交失败</h3>
                            <p>${data.message}</p>
                        </div>
                    `;
                }
                
                // 刷新日志
                loadRecentLogs();
                
            } catch (error) {
                resultPanel.innerHTML = `
                <div class="error">
                    <h3>请求失败</h3>
                    <pre>${error.message}</pre>
                    <p>请尝试以下步骤：</p>
                    <ol>
                    <li>检查网络连接</li>
                    <li>刷新页面重试</li>
                    <li>查看控制台获取更多信息</li>
                    <li>直接测试 <a href="/api/debug" target="_blank">/api/debug</a></li>
                    </ol>
                </div>
                `;
                console.error('提交请求失败详情:', error);
            }
        }
    </script>
</body>
</html>